import React, { useRef, useEffect, useState } from "react";
import Map from "@arcgis/core/Map";
import MapView from "@arcgis/core/views/MapView";
import Graphic from "@arcgis/core/Graphic";
import GraphicsLayer from "@arcgis/core/layers/GraphicsLayer";
import Polygon from "@arcgis/core/geometry/Polygon";
import SimpleFillSymbol from "@arcgis/core/symbols/SimpleFillSymbol";
import PictureMarkerSymbol from "@arcgis/core/symbols/PictureMarkerSymbol";
import Point from "@arcgis/core/geometry/Point";
import Polyline from "@arcgis/core/geometry/Polyline";
import SpatialReference from "@arcgis/core/geometry/SpatialReference";

import "@arcgis/core/assets/esri/themes/light/main.css";

const MapComponent = () => {
  const mapRef = useRef(null);
  const [mapView, setMapView] = useState(null);

  useEffect(() => {
    // Initialize the map and view only once when the component mounts
    if (!mapView && mapRef.current) {
      const map = new Map({
        basemap: "streets-navigation-vector",
      });

      const view = new MapView({
        container: mapRef.current,
        map: map,
        center: [106.803207, 10.871367],
        zoom: 17,
      });

      setMapView(view);

      // Sample Data (replace with your actual data fetching)
      const sinhViens = [
        {
          MaSV: "SV001",
          TenSV: "Trần Trung Nghĩa",
          Lop: "CN1",
          Email: "nghia@example.com",
        },
        {
          MaSV: "SV002",
          TenSV: "Huỳnh Ngọc An Khang",
          Lop: "CN1",
          Email: "khang@example.com",
        },
        {
          MaSV: "SV003",
          TenSV: "Đỗ Nguyễn Uyên Thảo",
          Lop: "CN1",
          Email: "thao@example.com",
        },
        {
          MaSV: "SV004",
          TenSV: "Nguyễn Thị Như Ý",
          Lop: "CN1",
          Email: "nhuy@example.com",
        },
        {
          MaSV: "SV005",
          TenSV: "Lê Minh Hoàng",
          Lop: "CN1",
          Email: "hoang@example.com",
        },
        {
          MaSV: "SV006",
          TenSV: "Phạm Ngọc Hân",
          Lop: "CN1",
          Email: "han@example.com",
        },
        {
          MaSV: "SV007",
          TenSV: "Nguyễn Gia Bảo",
          Lop: "CN1",
          Email: "bao@example.com",
        },
        {
          MaSV: "SV008",
          TenSV: "Trần Thị Kim Ngân",
          Lop: "CN1",
          Email: "ngan@example.com",
        },
        {
          MaSV: "SV009",
          TenSV: "Võ Hoàng Yến",
          Lop: "CN1",
          Email: "yen@example.com",
        },
        {
          MaSV: "SV010",
          TenSV: "Phan Minh Tuấn",
          Lop: "CN1",
          Email: "tuan@example.com",
        },
        {
          MaSV: "SV011",
          TenSV: "Lý Thị Mai",
          Lop: "KT2",
          Email: "mai@example.com",
        },
        {
          MaSV: "SV012",
          TenSV: "Hoàng Văn Nam",
          Lop: "DT1",
          Email: "nam@example.com",
        },
        {
          MaSV: "SV013",
          TenSV: "Bùi Thúy Quỳnh",
          Lop: "TH3",
          Email: "quynh@example.com",
        },
        {
          MaSV: "SV014",
          TenSV: "Đặng Quốc Việt",
          Lop: "CN2",
          Email: "viet@example.com",
        },
        {
          MaSV: "SV015",
          TenSV: "Trương Khánh Linh",
          Lop: "QT1",
          Email: "linh@example.com",
        },
        {
          MaSV: "SV016",
          TenSV: "Cao Đức Mạnh",
          Lop: "KT1",
          Email: "manh@example.com",
        },
        {
          MaSV: "SV017",
          TenSV: "Ngô Thu Hà",
          Lop: "DT2",
          Email: "ha@example.com",
        },
        {
          MaSV: "SV018",
          TenSV: "Lưu Tuấn Anh",
          Lop: "TH1",
          Email: "anh@example.com",
        },
        {
          MaSV: "SV019",
          TenSV: "Phùng Diệu Hương",
          Lop: "CN3",
          Email: "huong@example.com",
        },
        {
          MaSV: "SV020",
          TenSV: "Đinh Tiến Dũng",
          Lop: "QT2",
          Email: "dung@example.com",
        },
      ];

      const theSinhViens = sinhViens.map((sv, index) => ({
        MaThe: `THE${(index + 1).toString().padStart(3, "0")}`,
        MaSV: sv.MaSV,
        NgayCap: "2024-01-01",
        NgayHetHan: "2028-01-01",
      }));

      const points = [
        { MaSV: "SV001", ToaDo: [106.80340748467131, 10.871571994649642] },
        { MaSV: "SV002", ToaDo: [106.80442545318942, 10.87002829998059] },
        { MaSV: "SV003", ToaDo: [106.80318260880637, 10.870056266649627] },
        { MaSV: "SV004", ToaDo: [106.80306738506118, 10.869956229876465] },
        { MaSV: "SV005", ToaDo: [106.80293713213268, 10.869880792286978] },
        { MaSV: "SV006", ToaDo: [106.80293546222356, 10.869849633277482] },
        { MaSV: "SV007", ToaDo: [106.80293212240537, 10.869793875040983] },
        { MaSV: "SV008", ToaDo: [106.80293045249624, 10.869757796177026] },
        { MaSV: "SV009", ToaDo: [106.80260148035455, 10.870023467710993] },
        { MaSV: "SV010", ToaDo: [106.80266159709078, 10.869998868504808] },
        { MaSV: "SV011", ToaDo: [106.80374870807344, 10.869800434834445] },
        { MaSV: "SV012", ToaDo: [106.8038038150824, 10.869752876331574] },
        { MaSV: "SV013", ToaDo: [106.80388898045811, 10.869780755454968] },
        { MaSV: "SV014", ToaDo: [106.80383721326876, 10.869682358537403] },
        { MaSV: "SV015", ToaDo: [106.80397080601688, 10.869774195661037] },
        { MaSV: "SV016", ToaDo: [106.80314587080045, 10.86987423249596] },
        { MaSV: "SV017", ToaDo: [106.80324606536084, 10.869875872443544] },
        { MaSV: "SV018", ToaDo: [106.80307740451724, 10.869962789665678] },
        { MaSV: "SV019", ToaDo: [106.80315088052913, 10.870034947340315] },
        { MaSV: "SV020", ToaDo: [106.8028085491132, 10.869939830401776] },
      ];

      const routes = [
        {
          TenDuong: "Đường Tới Căn Tin",
          ToaDo: [
            [106.80388750381758, 10.869784350168601],
            [106.80450319899688, 10.869798230706948],
            [106.80462994717658, 10.869695962801117],
            [106.80487406608546, 10.869921980047224],
            [106.80486145741526, 10.869951133285596],
            [106.80485676304, 10.87008532950469],
            [106.80460755164876, 10.870090288514689],
            [106.80460278761234, 10.87003700139509],
          ],
        },
        {
          TenDuong: "Đường tới tòa nhà A",
          ToaDo: [
            [106.80268831564075, 10.870238300692932],
            [106.80251130525016, 10.87006610633047],
            [106.80293379231449, 10.86989227192106],
          ],
        },
        {
          TenDuong: "Đường tới tòa nhà C",
          ToaDo: [
            [106.80293546222356, 10.86989227192106],
            [106.8029287825857, 10.869661039201375],
            [106.80290540385539, 10.86962496032136],
            [106.80278517038295, 10.869606920879377],
          ],
        },
        {
          TenDuong: "Đường tới tòa nhà B",
          ToaDo: [
            [106.80293546222356, 10.86989227192106],
            [106.8033245511001, 10.869872592547651],
            [106.80374369834618, 10.869803714730438],
            [106.80375872752956, 10.869859472965118],
            [106.80379713544454, 10.869880792286978],
            [106.80384890263383, 10.869877512391142],
            [106.80389065036712, 10.869843073485072],
            [106.80389232027767, 10.869779115506176],
            [106.80382552390358, 10.869743036640457],
            [106.8037654071673, 10.869761076074198],
            [106.80374703816437, 10.869803714730438],
          ],
        },
        {
          TenDuong: "Đường đi",
          ToaDo: [
            [106.80293501714743, 10.869892985635687],
            [106.80307165313786, 10.869958441462046],
            [106.80325494532093, 10.870130808403559],
            [106.80324392200657, 10.870508906028007],
          ],
        },
        {
          TenDuong: "Đường tới sân bóng UIT",
          ToaDo: [
            [106.80382678398911, 10.869741352729676],
            [106.80383895954498, 10.869618792348689],
            [106.80381613037758, 10.869254100186254],
            [106.80366089203312, 10.869307907254566],
            [106.80345847340936, 10.869298939410555],
            [106.8034599953537, 10.869266057312998],
          ],
        },
        {
          TenDuong: "Đường tới sân bóng chuyền UIT",
          ToaDo: [
            [106.80345847340936, 10.869298939410555],
            [106.80320278672656, 10.869282498362196],
            [106.80308103116238, 10.869298939410555],
            [106.80307950921804, 10.869246626981322],
          ],
        },
        {
          TenDuong: "Đường tới sân bóng rổ UIT",
          ToaDo: [
            [106.80308103116238, 10.869297444770055],
            [106.80287100281578, 10.869301928691499],
            [106.80286948087144, 10.86923018593015],
          ],
        },
      ];

      const viTris = [
        {
          MaViTri: "V001",
          TenViTri: "Đại học Công nghệ thông tin",
          Color: [0, 255, 0],
          ToaDo: [
            [106.80340748467131, 10.871571994649642],
            [106.8030283165429, 10.871839610105766],
            [106.80301672685647, 10.871834413472442],
            [106.80292920067978, 10.871736802404925],
            [106.80293935322618, 10.871688408554078],
            [106.80289404058743, 10.871568172044647],
            [106.80257910654558, 10.871072485337208],
            [106.80229707337952, 10.870736424011056],
            [106.80225881641508, 10.87076451881184],
            [106.80211039190141, 10.870599656173283],
            [106.80195821132486, 10.870407914565021],
            [106.80227857983084, 10.870123410916577],
            [106.80228926376321, 10.869477142712924],
            [106.80240292344052, 10.869339118667071],
            [106.80279821860444, 10.869279438849617],
            [106.80281739144033, 10.86899312212202],
            [106.80296424563136, 10.868927758076666],
            [106.80316742468642, 10.868932759459142],
            [106.8032168640787, 10.868958924256106],
            [106.80321709489897, 10.86883527969124],
            [106.80326306953458, 10.868873681096062],
            [106.80329611016793, 10.868857559401604],
            [106.8033282512456, 10.868855122794159],
            [106.80378330914175, 10.86909556398544],
            [106.80381300115141, 10.869126719184052],
            [106.80382463362179, 10.86918721090079],
            [106.80380352919269, 10.869217434251965],
            [106.80384938921571, 10.869250026104723],
            [106.80383654456506, 10.8693336522621],
            [106.80386102158275, 10.869626559674046],
            [106.8041795725689, 10.869654071572484],
            [106.80424196303113, 10.86970348933096],
            [106.804263391495, 10.869778360466057],
            [106.80450910053315, 10.869785058770447],
            [106.8046335719419, 10.869667343666919],
            [106.80489240633648, 10.869916431227665],
            [106.80490215918996, 10.869946655650125],
            [106.80487535982991, 10.86997330038021],
            [106.80491807123627, 10.870008994580502],
            [106.80488803376284, 10.870382217165513],
            [106.80485432854744, 10.870414547837427],
            [106.80447093243265, 10.87041263024517],
            [106.80457411458804, 10.870542233583791],
            [106.80457998406246, 10.870656376749466],
            [106.80455317559245, 10.8707083929486],
            [106.80344284146929, 10.871543926733949],
            [106.80343544509196, 10.871574670482033],
            [106.80340617570806, 10.871579019643491],
          ],
        },
        {
          MaViTri: "V002",
          TenViTri: "Căn Tin",
          Color: [0, 0, 255],
          ToaDo: [
            [106.80442545318942, 10.87002829998059],
            [106.80450024916087, 10.870030359437266],
            [106.8045310063817, 10.870044775631058],
            [106.8045834334643, 10.870043402660414],
            [106.8046058023532, 10.870031732407966],
            [106.80467220999026, 10.870029672952512],
            [106.80466941387965, 10.86989031637249],
            [106.80471694776799, 10.869834711020005],
            [106.8046058023532, 10.869731051631106],
            [106.80449955013262, 10.86982510021744],
            [106.80444362791104, 10.869825786702663],
            [106.80440168624517, 10.86982921913237],
            [106.80436393874658, 10.869861483969245],
            [106.80434925916256, 10.86990130014425],
            [106.80435065721906, 10.86994042983018],
            [106.80437302610676, 10.869974754110899],
            [106.80442405513406, 10.869994662192084],
            [106.80442335610581, 10.870027613495836],
            [106.80455127818698, 10.869987797336478],
          ],
        },
        {
          MaViTri: "V003",
          TenViTri: "Sân Bóng UIT",
          Color: [255, 255, 0],
          ToaDo: [
            [106.80380405093655, 10.869220151009785],
            [106.803662253771, 10.869283237561177],
            [106.80324173961435, 10.869258220129979],
            [106.80321142187012, 10.869094232738917],
            [106.80324859168502, 10.868913606564021],
            [106.80329935981854, 10.868853678182859],
            [106.80377977448308, 10.869096430599896],
            [106.8038055284016, 10.869221168616264],
          ],
        },
        {
          MaViTri: "V004",
          TenViTri: "Sân Bóng Chuyền UIT",
          Color: [255, 0, 255],
          ToaDo: [
            [106.8030072949619, 10.869048059206776],
            [106.80314838287978, 10.86904874291173],
            [106.80313948180475, 10.869246620052778],
            [106.80301433968475, 10.869246558143672],
            [106.80300841380233, 10.869049350256432],
          ],
        },
        {
          MaViTri: "V005",
          TenViTri: "Sân Bóng Rổ UIT",
          Color: [0, 255, 255],
          ToaDo: [
            [106.80293430726181, 10.8692298378471],
            [106.80294193157852, 10.86900489835601],
            [106.80281380101002, 10.869006057539949],
            [106.80280143528813, 10.86922794907403],
            [106.8029331005107, 10.86922844535664],
          ],
        },
        {
          MaViTri: "V006",
          TenViTri: "Trong Khuôn Viên Trường",
          Color: [255, 165, 0],
          ToaDo: [
            [106.80378594172527, 10.869286716532187],
            [106.80366784894113, 10.8693417689731],
            [106.80320677239627, 10.869311822775359],
            [106.80277873292488, 10.869342831058518],
            [106.80243186177177, 10.869385280771354],
            [106.80234547514681, 10.86949185364314],
            [106.8023470177776, 10.870092131726622],
            [106.80251780916325, 10.870035950829433],
            [106.80254196147303, 10.870048390992153],
            [106.80251636629822, 10.870096858591907],
            [106.80222535842614, 10.870406545112857],
            [106.80324216780281, 10.871322895325221],
            [106.80321473190418, 10.870523697300058],
            [106.80337566989198, 10.870270781178718],
            [106.80339399126092, 10.870253520236531],
            [106.80383050205052, 10.87026222008285],
            [106.80396614305602, 10.870205790677247],
            [106.80412885622792, 10.870090398040048],
            [106.80419241360454, 10.869980154171728],
            [106.80421596802876, 10.869861310041273],
            [106.80419642629897, 10.86972928402487],
            [106.804160113269, 10.869706678818304],
            [106.80383288950185, 10.869669123639255],
            [106.80381141690202, 10.869655010081772],
            [106.80377650865142, 10.869337365164029],
            [106.80378836834444, 10.869287405463837],
          ],
        },
        {
          MaViTri: "V007",
          TenViTri: "Thư Viện UIT",
          Color: [0, 127, 255],
          ToaDo: [
            [106.80288451664705, 10.870542305776112],
            [106.80284397108989, 10.870600501308004],
            [106.80288295720277, 10.870634193452773],
            [106.80288295720277, 10.870718423796674],
            [106.80285800609084, 10.870752115926791],
            [106.80291726498018, 10.870816437258583],
            [106.80296560775986, 10.870778150752955],
            [106.80302642609348, 10.870787339514479],
            [106.80307944720585, 10.870831751858134],
            [106.80318237054081, 10.870727612560103],
            [106.80315741942889, 10.870706172110857],
            [106.80317457331824, 10.870683200200915],
            [106.80317613276253, 10.870646445140238],
            [106.80314650331786, 10.87061275299682],
            [106.80317769220682, 10.87056834062058],
            [106.80308568498418, 10.870490236081793],
            [106.80304046109438, 10.870525459700346],
            [106.80301083164835, 10.870500956313705],
          ],
        },
        {
          MaViTri: "V008",
          TenViTri: "Tòa nhà A",
          Color: [0, 0, 255],
          ToaDo: [
            [106.80288139775473, 10.870539242854392],
            [106.80282057942111, 10.870477984387378],
            [106.80278783108662, 10.870511676545988],
            [106.80263812441757, 10.87036925057808],
            [106.80268490775165, 10.870301866226214],
            [106.80269270497422, 10.87021457283744],
            [106.80263188663923, 10.870147188450701],
            [106.80280030664329, 10.869989447666796],
            [106.8030295449795, 10.869986384737217],
            [106.80318704887117, 10.870133405278054],
            [106.80313714664857, 10.87019619527885],
            [106.8031433844269, 10.870300334763698],
            [106.80317925164991, 10.870349341566708],
            [106.80301395053567, 10.870496361928645],
          ],
        },
        {
          MaViTri: "V009",
          TenViTri: "Tòa nhà B",
          Color: [0, 127, 255],
          ToaDo: [
            [106.80370115805977, 10.869937791527576],
            [106.80363933554531, 10.869959539568157],
            [106.80368639447471, 10.87003656386652],
            [106.80375559878081, 10.870042907042944],
            [106.80388570287982, 10.870028408353164],
            [106.8039539844628, 10.870003035644586],
            [106.80397889801384, 10.86998038143905],
            [106.80394567994637, 10.869944134706117],
            [106.80398535708235, 10.86986257954149],
            [106.80423449258961, 10.86985079934935],
            [106.80417543824632, 10.870006660317614],
            [106.8041339156623, 10.870078247595274],
            [106.80406932497516, 10.87014621018524],
            [106.80401119335664, 10.870187893899484],
            [106.80380911677884, 10.8702241406028],
            [106.8037436033685, 10.870225952937531],
            [106.80367070816487, 10.87020964192186],
            [106.80354890858399, 10.870153459526946],
            [106.80348154972421, 10.870080966099536],
            [106.8034280317263, 10.86997947527091],
            [106.80340865452064, 10.869877078239298],
            [106.80362364923548, 10.869825426625653],
            [106.80370023533499, 10.869939603864864],
            [106.80364118099328, 10.869959539568157],
          ],
        },
        {
          MaViTri: "V010",
          TenViTri: "Tòa nhà E",
          Color: [0, 127, 255],
          ToaDo: [
            [106.80238179242599, 10.869677180419956],
            [106.80238179242599, 10.869691270612108],
            [106.802385891742, 10.869703347919383],
            [106.80240023934994, 10.86971039301578],
            [106.8024238104216, 10.86971039301578],
            [106.80242586007961, 10.869799966360773],
            [106.80271281224498, 10.869802985686079],
            [106.8027107625851, 10.869774805310797],
            [106.80273433365682, 10.869776818195419],
            [106.80273433365682, 10.869801979244272],
            [106.80275687989865, 10.869818082314836],
            [106.80279274891836, 10.869831166058674],
            [106.80281836964804, 10.869821101639985],
            [106.80282554345195, 10.869803992127828],
            [106.80280607169817, 10.869727502532413],
            [106.80275380541065, 10.869727502532413],
            [106.80271998604888, 10.869673154650314],
            [106.80238896623001, 10.869677180419956],
          ],
        },
        {
          MaViTri: "V011",
          TenViTri: "Tòa nhà C",
          Color: [0, 127, 255],
          ToaDo: [
            [106.80260860394941, 10.869516924036134],
            [106.80260617838195, 10.86940496761369],
            [106.80277414895033, 10.869404372100263],
            [106.80277414895033, 10.869329932966252],
            [106.80366857706633, 10.869326955401462],
            [106.80366978984893, 10.869436529800865],
            [106.80372739708412, 10.869436529800865],
            [106.80372860986887, 10.86949012596051],
            [106.80367221541644, 10.869491912498177],
            [106.8036679706729, 10.869586003510065],
            [106.8035157662959, 10.869586599022114],
            [106.80351455351115, 10.869555036850798],
            [106.80345815906082, 10.869557418902275],
            [106.80345694627812, 10.869596722736802],
            [106.80341510523442, 10.869596127224781],
            [106.80341510523442, 10.86955622787606],
            [106.8033611363515, 10.869557418902275],
            [106.80335749799934, 10.869591958635482],
            [106.80277900008514, 10.869596127224781],
            [106.80277641674218, 10.869516525742611],
            [106.80260854656677, 10.869515497147162],
          ],
        },
      ];

      const thietBis = viTris.map((vt, index) => ({
        MaTB: `TB${(index + 1).toString().padStart(3, "0")}`,
        MaViTri: vt.MaViTri,
        TenTB: `Thiết bị ${index + 1}`,
      }));

      const giaoDichs = [
        {
          MaGD: "GD001",
          MaThe: "THE001",
          MaViTri: "V001",
          ThoiGian: "2025-04-27 08:00",
        },
        {
          MaGD: "GD002",
          MaThe: "THE002",
          MaViTri: "V002",
          ThoiGian: "2025-04-27 08:10",
        },
        {
          MaGD: "GD003",
          MaThe: "THE003",
          MaViTri: "V003",
          ThoiGian: "2025-04-27 08:20",
        },
        {
          MaGD: "GD004",
          MaThe: "THE004",
          MaViTri: "V004",
          ThoiGian: "2025-04-27 08:30",
        },
        {
          MaGD: "GD005",
          MaThe: "THE005",
          MaViTri: "V005",
          ThoiGian: "2025-04-27 08:40",
        },
        {
          MaGD: "GD006",
          MaThe: "THE006",
          MaViTri: "V006",
          ThoiGian: "2025-04-27 08:50",
        },
        {
          MaGD: "GD007",
          MaThe: "THE007",
          MaViTri: "V006",
          ThoiGian: "2025-04-27 12:50",
        },
        {
          MaGD: "GD008",
          MaThe: "THE008",
          MaViTri: "V005",
          ThoiGian: "2025-04-27 13:50",
        },
        {
          MaGD: "GD009",
          MaThe: "THE009",
          MaViTri: "V008",
          ThoiGian: "2025-04-27 12:50",
        },
        {
          MaGD: "GD010",
          MaThe: "THE010",
          MaViTri: "V009",
          ThoiGian: "2025-04-27 10:50",
        },
        {
          MaGD: "GD011",
          MaThe: "THE011",
          MaViTri: "V010",
          ThoiGian: "2025-04-27 08:50",
        },
        {
          MaGD: "GD012",
          MaThe: "THE012",
          MaViTri: "V011",
          ThoiGian: "2025-04-27 09:50",
        },
      ];

      const graphicsLayer = new GraphicsLayer();
      map.add(graphicsLayer);

      // Draw student points
      points.forEach((sv) => {
        const point = new Point({
          longitude: sv.ToaDo[0],
          latitude: sv.ToaDo[1],
        });

        const markerSymbol = new PictureMarkerSymbol({
          url: "http://static.arcgis.com/images/Symbols/Basic/YellowStickpin.png",
          width: "24px",
          height: "24px",
        });

        const sinhVien = sinhViens.find((v) => v.MaSV === sv.MaSV);
        const pointGraphic = new Graphic({
          geometry: point,
          symbol: markerSymbol,
          attributes: sinhVien,
          popupTemplate: {
            title: "Thông Tin Sinh Viên",
            content:
              "<b>Mã Sinh Viên:</b> {MaSV}<br><b>Tên Sinh Viên:</b> {TenSV}<br><b>Lớp:</b> {Lop}",
          },
        });
        view.graphics.add(pointGraphic);
      });

      // Draw locations
      viTris.forEach((vt) => {
        const thietBiText = thietBis
          .filter((tb) => tb.MaViTri === vt.MaViTri)
          .map((tb) => tb.TenTB)
          .join(", ");

        const giaoDichText = giaoDichs
          .filter((gd) => gd.MaViTri === vt.MaViTri)
          .map((gd) => {
            const theSinhVien = theSinhViens.find(
              (sv) => sv.MaThe === gd.MaThe,
            );
            const sinhVien = sinhViens.find(
              (sv) => sv.MaSV === theSinhVien?.MaSV,
            );
            return `${theSinhVien?.MaThe || ""} - ${sinhVien?.TenSV || ""}`;
          })
          .join(", ");

        const polygon = new Polygon({
          rings: vt.ToaDo,
          spatialReference: { wkid: 4326 },
        });
        const backgroundColor = [...vt.Color, 0.3];
        const symbol = new SimpleFillSymbol({
          color: backgroundColor,
          size: "15px",
          outline: {
            color: vt.Color,
            width: 2,
          },
        });

        const popupContent = `
          <b>Vị trí:</b> ${vt.TenViTri}<br>
          <b>Thiết bị:</b> ${thietBiText}<br>
          <b>Giao dịch:</b><br> ${giaoDichText}
        `;

        const graphic = new Graphic({
          geometry: polygon,
          symbol: symbol,
          popupTemplate: {
            title: "Thông tin khu vực",
            content: popupContent,
          },
        });
        graphicsLayer.add(graphic);
      });

      // Draw routes
      routes.forEach((route) => {
        const path = route.ToaDo.map((coord) => [coord[0], coord[1]]);

        const polyline = new Polyline({
          paths: [path],
          spatialReference: new SpatialReference({ wkid: 4326 }),
        });

        const polylineGraphic = new Graphic({
          geometry: polyline,
          symbol: {
            type: "simple-line",
            color: [226, 119, 40],
            width: 4,
          },
          attributes: {
            name: route.TenDuong,
            startPoint: `${route.ToaDo[0][0]}, ${route.ToaDo[0][1]}`,
            endPoint: `${route.ToaDo[route.ToaDo.length - 1][0]}, ${
              route.ToaDo[route.ToaDo.length - 1][1]
            }`,
          },
          popupTemplate: {
            title: "Thông Tin Đoạn Đường",
            content:
              "<h3>{name}</h3>" +
              "<p><strong>Toạ độ bắt đầu:</strong> {startPoint}</p>" +
              "<p><strong>Toạ độ kết thúc:</strong> {endPoint}</p>",
          },
        });
        view.graphics.add(polylineGraphic);
      });
    }

    return () => {
      // Cleanup the map view when the component unmounts
      if (mapView) {
        mapView.destroy();
      }
    };
  }, [mapView]);

  return (
    <div
      id="viewDiv"
      ref={mapRef}
      style={{ width: "100%", height: "100vh" }}
    ></div>
  );
};

export default MapComponent;
